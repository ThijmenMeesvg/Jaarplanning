<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Bevers – Jaarplanning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="topbar">
    <div class="topbar-left">
      <img
        class="topbar-logo"
        src="https://www.oliviervannoort.nl/images/logo-oliviervannoort-blauw-transparant.png"
        alt="Logo Scouting Olivier van Noort"
      >
      <div class="topbar-title">
        <h1>Bevers – Jaarplanning</h1>
        <span>Overzicht opkomsten en aanwezigheid</span>
      </div>
    </div>
    <a class="backlink" href="index.html">← Terug naar overzicht</a>
  </header>

  <main class="container">
    <section class="info-block">
      <h2>Bevers</h2>
      <p>
        Op deze pagina staat de jaarplanning van de Bevers.
        De tabel wordt gevuld vanuit de Realtime Database. Door op de vakjes te klikken
        kun je de aanwezigheid per kind of leiding aanpassen (– → ✔ → ✖ → –).
      </p>
    </section>

    <section>
      <h2>Planning</h2>
      <div class="table-wrapper">
        <table class="planning-table">
          <thead>
            <tr id="planning-head-row">
              <!-- wordt door JavaScript gevuld -->
            </tr>
          </thead>
          <tbody id="planning-body">
            <!-- wordt door JavaScript gevuld -->
          </tbody>
        </table>
      </div>
    </section>

    <section class="admin-section">
      <button id="editModeButton">Bewerkmodus (alleen leiding)</button>
      <p class="admin-hint">
        Met bewerkmodus kunnen leidinggevenden leden beheren en later ook de planning aanpassen.
        Ouders krijgen dit wachtwoord niet.
      </p>

      <div id="adminMembers" class="admin-members hidden">
        <h3>Leden beheren</h3>
        <div id="membersList" class="members-list">
          <!-- lijst met huidige leden komt hier -->
        </div>

        <form id="addMemberForm" class="add-member-form">
          <div class="form-row">
            <label>
              Naam
              <input type="text" id="newMemberName" required placeholder="Bijv. Sofie">
            </label>
          </div>
          <div class="form-row">
            <label>
              Type
              <select id="newMemberType">
                <option value="jeugdlid">Jeugdlid</option>
                <option value="leiding">Leiding</option>
              </select>
            </label>
          </div>
          <button type="submit">Lid toevoegen</button>
        </form>
      </div>
    </section>
  </main>

  <!-- Firebase (modulaire SDK, versie 12) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      child,
      get,
      update,
      push
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    // JOUW CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyAZN4QdTuOpk8lEKsyPuhynqZ9-GJLDE0s",
      authDomain: "jaarplanning-ovn.firebaseapp.com",
      databaseURL: "https://jaarplanning-ovn-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "jaarplanning-ovn",
      storageBucket: "jaarplanning-ovn.firebasestorage.app",
      messagingSenderId: "526104562356",
      appId: "1:526104562356:web:ea211e722202d6383f65e1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Simpel wachtwoord voor bewerkmodus – verander dit zelf in iets eigens
    const ADMIN_PASSWORD = "bevers2025";

    let leden = [];
    let opkomsten = [];
    let isAdmin = false;

    document.addEventListener("DOMContentLoaded", () => {
      const storedAdmin = localStorage.getItem("beversAdmin") === "true";
      isAdmin = storedAdmin;

      const editButton = document.getElementById("editModeButton");
      const addMemberForm = document.getElementById("addMemberForm");

      if (editButton) {
        editButton.addEventListener("click", onEditModeClick);
      }
      if (addMemberForm) {
        addMemberForm.addEventListener("submit", onAddMemberSubmit);
      }

      updateAdminUI();
      loadData();
    });

    async function loadData() {
      try {
        const rootRef = ref(db);
        const snapshot = await get(child(rootRef, "bevers"));

        if (!snapshot.exists()) {
          console.warn("Geen data gevonden onder /bevers");
          return;
        }

        const data = snapshot.val() || {};
        const ledenObj = data.leden || {};
        const opkomstenObj = data.opkomsten || {};

        // leden → array met id, naam, volgorde, type
        leden = Object.entries(ledenObj).map(([id, value]) => ({
          id,
          naam: value.naam || id,
          volgorde: value.volgorde ?? 0,
          type: value.type || "jeugdlid"
        })).sort((a, b) => a.volgorde - b.volgorde || a.naam.localeCompare(b.naam));

        // opkomsten → array met id + data, gesorteerd op datum (YYYY-MM-DD)
        opkomsten = Object.entries(opkomstenObj).map(([id, value]) => ({
          id,
          datum: value.datum,
          thema: value.thema || "",
          bijzonderheden: value.bijzonderheden || "",
          leiding: value.leiding || "",
          aanwezigheid: value.aanwezigheid || {}
        })).sort((a, b) => {
          if (!a.datum || !b.datum) return 0;
          return a.datum.localeCompare(b.datum);
        });

        renderTable();
        renderMembersAdmin();
      } catch (err) {
        console.error("Fout bij laden data:", err);
        alert("Er ging iets mis bij het ophalen van de Bevers-data.");
      }
    }

    function renderTable() {
      const headRow = document.getElementById("planning-head-row");
      const body = document.getElementById("planning-body");

      headRow.innerHTML = "";
      body.innerHTML = "";

      // vaste kolommen
      ["Datum", "Thema", "Bijzonderheden", "Leiding"].forEach(label => {
        const th = document.createElement("th");
        th.textContent = label;
        headRow.appendChild(th);
      });

      // leden-kolommen (zowel jeugdlid als leiding, zodat je ook leiding-aanwezigheid kunt bijhouden)
      leden.forEach(lid => {
        const th = document.createElement("th");
        th.textContent = lid.naam;
        headRow.appendChild(th);
      });

      // rijen
      opkomsten.forEach(opkomst => {
        const tr = document.createElement("tr");

        addTextCell(tr, formatDate(opkomst.datum));
        addTextCell(tr, opkomst.thema);
        addTextCell(tr, opkomst.bijzonderheden);
        addTextCell(tr, opkomst.leiding);

        leden.forEach(lid => {
          const td = document.createElement("td");
          td.classList.add("presence-cell");

          const state = (opkomst.aanwezigheid && opkomst.aanwezigheid[lid.id]) || "onbekend";

          td.dataset.opkomstId = opkomst.id;
          td.dataset.lidId = lid.id;
          td.dataset.state = state;

          updatePresenceCellAppearance(td);
          td.addEventListener("click", onPresenceClick);

          tr.appendChild(td);
        });

        body.appendChild(tr);
      });
    }

    function addTextCell(tr, text) {
      const td = document.createElement("td");
      td.textContent = text || "";
      tr.appendChild(td);
    }

    function formatDate(isoStr) {
      if (!isoStr) return "";
      const parts = isoStr.split("-");
      if (parts.length !== 3) return isoStr;
      return `${parts[2]}-${parts[1]}-${parts[0]}`; // dd-mm-jjjj
    }

    function updatePresenceCellAppearance(td) {
      const state = td.dataset.state || "onbekend";
      td.classList.remove("presence-aanwezig", "presence-afwezig");

      if (state === "aanwezig") {
        td.textContent = "✔";
        td.classList.add("presence-aanwezig");
      } else if (state === "afwezig") {
        td.textContent = "✖";
        td.classList.add("presence-afwezig");
      } else {
        td.textContent = "–";
      }
    }

    async function onPresenceClick(event) {
      const td = event.currentTarget;
      const current = td.dataset.state || "onbekend";
      let next;

      if (current === "onbekend") {
        next = "aanwezig";
      } else if (current === "aanwezig") {
        next = "afwezig";
      } else {
        next = "onbekend";
      }

      td.dataset.state = next;
      updatePresenceCellAppearance(td);

      const opkomstId = td.dataset.opkomstId;
      const lidId = td.dataset.lidId;

      const updatesObj = {};
      updatesObj[`bevers/opkomsten/${opkomstId}/aanwezigheid/${lidId}`] = next;

      try {
        await update(ref(db), updatesObj);
      } catch (err) {
        console.error("Fout bij opslaan aanwezigheid:", err);
        alert("Opslaan van aanwezigheid is mislukt.");
      }
    }

    // === Bewerkmodus (wachtwoord) ===

    function onEditModeClick() {
      if (isAdmin) {
        // uitschakelen
        isAdmin = false;
        localStorage.removeItem("beversAdmin");
        updateAdminUI();
        return;
      }

      const pw = prompt("Voer het wachtwoord voor de Bevers-beheerder in:");
      if (pw === null) {
        return; // gebruiker annuleerde
      }
      if (pw === ADMIN_PASSWORD) {
        isAdmin = true;
        localStorage.setItem("beversAdmin", "true");
        updateAdminUI();
      } else {
        alert("Onjuist wachtwoord.");
      }
    }

    function updateAdminUI() {
      const adminMembers = document.getElementById("adminMembers");
      const editButton = document.getElementById("editModeButton");
      if (!adminMembers || !editButton) return;

      if (isAdmin) {
        adminMembers.classList.remove("hidden");
        editButton.textContent = "Bewerkmodus uitschakelen";
        editButton.disabled = false;
      } else {
        adminMembers.classList.add("hidden");
        editButton.textContent = "Bewerkmodus (alleen leiding)";
        editButton.disabled = false;
      }
    }

    // === Ledenbeheer ===

    function renderMembersAdmin() {
      const list = document.getElementById("membersList");
      if (!list) return;

      list.innerHTML = "";
      if (!leden.length) {
        list.textContent = "Nog geen leden toegevoegd.";
        return;
      }

      leden.forEach(lid => {
        const div = document.createElement("div");
        div.className = "member-row";
        const typeLabel = lid.type === "leiding" ? "Leiding" : "Jeugdlid";
        div.textContent = `${lid.naam} (${typeLabel})`;
        list.appendChild(div);
      });
    }

    async function onAddMemberSubmit(event) {
      event.preventDefault();
      if (!isAdmin) {
        alert("Alleen leiding kan leden toevoegen (schakel bewerkmodus in).");
        return;
      }

      const nameInput = document.getElementById("newMemberName");
      const typeSelect = document.getElementById("newMemberType");
      const name = nameInput.value.trim();
      const type = typeSelect.value;

      if (!name) {
        alert("Vul een naam in.");
        return;
      }

      const volgorde =
        leden.length
          ? Math.max(...leden.map(l => l.volgorde || 0)) + 1
          : 1;

      try {
        const updatesObj = {};
        // nieuwe push-ID voor het lid
        const ledenRef = ref(db, "bevers/leden");
        const newLidRef = push(ledenRef);
        const newId = newLidRef.key;

        updatesObj[`bevers/leden/${newId}`] = {
          naam: name,
          type: type,
          volgorde: volgorde
        };

        // voor alle bestaande opkomsten een "onbekend" bij dit nieuwe lid
        opkomsten.forEach(opkomst => {
          if (opkomst.id) {
            updatesObj[`bevers/opkomsten/${opkomst.id}/aanwezigheid/${newId}`] = "onbekend";
          }
        });

        await update(ref(db), updatesObj);

        // formulier resetten
        nameInput.value = "";
        typeSelect.value = "jeugdlid";

        // data opnieuw ophalen + tabel/ledenlijst verversen
        await loadData();
      } catch (err) {
        console.error("Fout bij toevoegen lid:", err);
        alert("Toevoegen van lid is mislukt.");
      }
    }
  </script>
</body>
</html>
