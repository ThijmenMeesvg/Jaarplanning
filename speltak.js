import{initializeApp}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import{getDatabase,ref,child,get,set,update,remove,push}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";const firebaseConfig={apiKey:"AIzaSyAZN4QdTuOpk8lEKsyPuhynqZ9-GJLDE0s",authDomain:"jaarplanning-ovn.firebaseapp.com",databaseURL:"https://jaarplanning-ovn-default-rtdb.europe-west1.firebasedatabase.app",projectId:"jaarplanning-ovn",storageBucket:"jaarplanning-ovn.firebasestorage.app",messagingSenderId:"526104562356",appId:"1:526104562356:web:ea211e722202d6383f65e1"};initializeApp(firebaseConfig);const db=getDatabase();let speltak="",isAdmin=false,leden=[],jeugd=[],leiding=[],opkomsten=[];const todayISO=new Date().toISOString().split("T")[0];document.addEventListener("DOMContentLoaded",()=>{speltak=document.body.dataset.speltak;document.getElementById("editButton").onclick=toggleAdmin;document.getElementById("addOpkomstRow").onclick=addNewOpkomst;document.getElementById("addMemberButton").onclick=addNewMember;loadData()});async function loadData(){const snap=await get(child(ref(db),speltak));const data=snap.exists()?snap.val():{leden:{},opkomsten:{}};leden=Object.entries(data.leden||{}).map(([id,v])=>({id,naam:v.naam,type:v.type==="jeugdlid"?"jeugd":v.type,volgorde:v.volgorde||0}));jeugd=leden.filter(l=>l.type==="jeugd").sort((a,b)=>a.volgorde-b.volgorde);leiding=leden.filter(l=>l.type==="leiding").sort((a,b)=>a.volgorde-b.volgorde);opkomsten=Object.entries(data.opkomsten||{}).map(([id,v])=>({id,...v}));opkomsten.sort((a,b)=>a.datum.localeCompare(b.datum));renderTable()}function toggleAdmin(){if(!isAdmin){const pw=prompt("Wachtwoord:");if(pw!=="bevers2025")return;isAdmin=true}else isAdmin=false;document.getElementById("addOpkomstRow").style.display=isAdmin?"table-row":"none";document.getElementById("addMemberButton").style.display=isAdmin?"inline-block":"none";renderTable()}function renderTable(){const h1=document.getElementById("headerRowTop"),h2=document.getElementById("headerRowBottom"),body=document.getElementById("tableBody");h1.innerHTML="";h2.innerHTML="";body.innerHTML="";addTH(h1,"ðŸ—‘",1,2);addTH(h1,"Datum",1,2);addTH(h1,"Thema",1,2);addTH(h1,"Bijzonderheden",1,2);addTH(h1,"Start",1,2);addTH(h1,"Eind",1,2);addTH(h1,"Procor",1,2);addTH(h1,"Bert ðŸ§¸",1,2);addTH(h1,"JEUGD",jeugd.length,1);addTH(h1,"LEIDING",leiding.length,1);for(let i=0;i<8;i++)addTH(h2,"");jeugd.forEach(j=>addTH(h2,j.naam));leiding.forEach(l=>addTH(h2,l.naam));let firstFuture=true;opkomsten.forEach(o=>{ensurePresence(o);const tr=document.createElement("tr");if(o.datum<todayISO)tr.classList.add("row-grey");else if(firstFuture){tr.classList.add("row-next");firstFuture=false}addDeleteCell(tr,o);addTextCell(tr,o,"datum","date");addTextCell(tr,o,"thema","text");addTextCell(tr,o,"bijzonderheden","text");addTextCell(tr,o,"starttijd","time");addTextCell(tr,o,"eindtijd","time");addProcorCell(tr,o);addBertCell(tr,o);jeugd.forEach(j=>tr.appendChild(makePresenceCell(o,j.id)));leiding.forEach(l=>tr.appendChild(makePresenceCell(o,"leiding-"+l.id)));body.appendChild(tr)})}function addTH(r,t,c=1,rs=1){const th=document.createElement("th");th.colSpan=c;th.rowSpan=rs;th.textContent=t;r.appendChild(th)}function getNaam(id){if(!id)return"";const f=leden.find(l=>l.id===id);return f?f.naam:""}function addDeleteCell(tr,o){const td=document.createElement("td");td.textContent=isAdmin?"ðŸ—‘":"";td.className="delete-btn";if(isAdmin)td.onclick=async()=>{await remove(ref(db,`${speltak}/opkomsten/${o.id}`));loadData()};tr.appendChild(td)}function addTextCell(tr,o,f,type){const td=document.createElement("td");td.textContent=o[f]||"";if(isAdmin){td.classList.add("editable");td.onclick=()=>editText(td,o,f,type)}tr.appendChild(td)}function editText(td,o,f,type){const old=td.textContent,input=document.createElement("input");input.type=type;input.value=old;td.textContent="";td.appendChild(input);input.focus();input.onblur=async()=>{await update(ref(db,`${speltak}/opkomsten/${o.id}`),{[f]:input.value});loadData()}}function addProcorCell(tr,o){const td=document.createElement("td");td.textContent=getNaam(o.procor);if(isAdmin){td.classList.add("editable");td.onclick=()=>editProcor(td,o)}tr.appendChild(td)}function editProcor(td,o){const sel=document.createElement("select");sel.innerHTML=`<option value=""></option>`+leiding.map(l=>`<option value="${l.id}">${l.naam}</option>`).join("");sel.value=o.procor||"";td.textContent="";td.appendChild(sel);sel.focus();sel.onblur=async()=>{await update(ref(db,`${speltak}/opkomsten/${o.id}`),{procor:sel.value});loadData()}}function addBertCell(tr,o){const td=document.createElement("td");td.textContent=getNaam(o.bert_met);if(isAdmin){td.classList.add("editable");td.onclick=()=>editBert(td,o)}tr.appendChild(td)}function editBert(td,o){const sel=document.createElement("select");sel.innerHTML=`<option value=""></option>`+jeugd.map(j=>`<option value="${j.id}">${j.naam}</option>`).join("");sel.value=o.bert_met||"";td.textContent="";td.appendChild(sel);sel.focus();sel.onblur=async()=>{await update(ref(db,`${speltak}/opkomsten/${o.id}`),{bert_met:sel.value});loadData()}}function ensurePresence(o){if(!o.aanwezigheid)o.aanwezigheid={};jeugd.forEach(j=>{if(!o.aanwezigheid[j.id])o.aanwezigheid[j.id]="onbekend"});leiding.forEach(l=>{const k="leiding-"+l.id;if(!o.aanwezigheid[k])o.aanwezigheid[k]="onbekend"});update(ref(db,`${speltak}/opkomsten/${o.id}`),{aanwezigheid:o.aanwezigheid})}function makePresenceCell(o,key){const state=o.aanwezigheid[key],td=document.createElement("td");td.classList.add("presence-cell");td.textContent=state==="aanwezig"?"âœ”":state==="afwezig"?"âœ–":"â€“";td.onclick=async()=>{const next=state==="onbekend"?"aanwezig":state==="aanwezig"?"afwezig":"onbekend";await update(ref(db,`${speltak}/opkomsten/${o.id}/aanwezigheid`),{[key]:next});loadData()};return td}async function addNewOpkomst(){if(!isAdmin)return;const id="opk-"+Date.now(),nieuw={datum:todayISO,thema:"",bijzonderheden:"",starttijd:"10:30",eindtijd:"12:30",procor:"",bert_met:"",typeOpkomst:"normaal",aanwezigheid:{}};await set(ref(db,`${speltak}/opkomsten/${id}`),nieuw);loadData()}async function addNewMember(){if(!isAdmin)return;const naam=prompt("Naam lid:");if(!naam)return;const type=prompt("Type (jeugd / leiding):","jeugd");if(!type)return;const id=push(ref(db,`${speltak}/leden`)).key;await set(ref(db,`${speltak}/leden/${id}`),{naam,type,volgorde:leden.length+1});loadData()}
